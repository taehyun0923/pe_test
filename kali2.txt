import os
import ssl
import sys
import re
import subprocess
from http.server import HTTPServer, BaseHTTPRequestHandler
from urllib.parse import parse_qs, unquote_plus
from datetime import datetime

# =========================================================================
# Python Standard Library Only HTTPS Server - 443 í¬íŠ¸
# ì €ì¥ ê²½ë¡œ: /home/kali/Downloads/received_transfer (ë˜ëŠ” /root/Downloads/received_transfer)
# =========================================================================

# -------------------------------------------------------------------------
# 1. íŒŒì¼ ì €ì¥ ê²½ë¡œ ì„¤ì • (ê²½ë¡œ ì—…ë°ì´íŠ¸)
# -------------------------------------------------------------------------
# Kali ì‚¬ìš©ìì˜ Downloads í´ë” ì•ˆì— 'received_transfer' í´ë”ë¥¼ ìƒì„±í•˜ì—¬ ì €ì¥í•©ë‹ˆë‹¤.
DOWNLOADS_DIR = os.path.join(os.path.expanduser('~'), "Downloads")
RECEIVE_DIR = os.path.join(DOWNLOADS_DIR, "received_transfer")

SERVER_ADDRESS = ('0.0.0.0', 443)

# -------------------------------------------------------------------------
# 2. SSL ì¸ì¦ì„œ ìƒì„± í•¨ìˆ˜ (ì´ì „ê³¼ ë™ì¼)
# -------------------------------------------------------------------------
def generate_ssl_certs():
    """
    Kaliì—ì„œ ì„œë²„ êµ¬ë™ì— í•„ìš”í•œ ìì²´ ì„œëª… SSL ì¸ì¦ì„œ(server.crt, server.key)ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
    (ê¸°ì¡´ íŒŒì¼ ì‚­ì œ ë° ë‹¨ì¼ ëª…ë ¹ìœ¼ë¡œ í‚¤ ë¶ˆì¼ì¹˜ ì˜¤ë¥˜ë¥¼ ê·¼ë³¸ì ìœ¼ë¡œ í•´ê²°í•©ë‹ˆë‹¤.)
    """
    cert_file = 'server.crt'
    key_file = 'server.key'
    
    # ğŸš¨ğŸš¨ğŸš¨ CRITICAL: ê¸°ì¡´ íŒŒì¼ì´ ìˆë‹¤ë©´ ì‚­ì œí•˜ì—¬ ë¶ˆì¼ì¹˜ ì˜¤ë¥˜ë¥¼ ë°©ì§€í•©ë‹ˆë‹¤. ğŸš¨ğŸš¨ğŸš¨
    if os.path.exists(cert_file):
        os.remove(cert_file)
    if os.path.exists(key_file):
        os.remove(key_file)
        
    print("â˜… SSL ì¸ì¦ì„œ íŒŒì¼ì´ ì—†ì–´ OpenSSL ëª…ë ¹ìœ¼ë¡œ ìì²´ ì„œëª… ì¸ì¦ì„œë¥¼ ìƒˆë¡œ ìƒì„±í•©ë‹ˆë‹¤...")
    try:
        # ë‹¨ì¼ ëª…ë ¹ìœ¼ë¡œ í‚¤ì™€ ì¸ì¦ì„œë¥¼ ë™ì‹œì— ìƒì„±í•˜ì—¬ ì¼ì¹˜ì„±ì„ ê°€ì¥ ê°•ë ¥í•˜ê²Œ ë³´ì¥í•©ë‹ˆë‹¤.
        cmd = (
            "openssl req -x509 -newkey rsa:4096 -keyout server.key "
            "-out server.crt -days 365 -nodes -subj '/CN=Kali_Listener/O=AITK_TEST'"
        )
        
        # OpenSSL ëª…ë ¹ ì‹¤í–‰
        result = subprocess.run(cmd, shell=True, check=False, capture_output=True, text=True)

        if os.path.exists(cert_file) and os.path.exists(key_file):
            print("â˜… SSL ì¸ì¦ì„œ ìƒì„± ì„±ê³µ: server.crt, server.key")
            return cert_file, key_file
        else:
            # OpenSSL ì‹¤í–‰ì— ì‹¤íŒ¨í–ˆì§€ë§Œ ì—ëŸ¬ ì½”ë“œë¥¼ ë°˜í™˜í•˜ì§€ ì•Šì•˜ì„ ê²½ìš°
            print(f"âŒ OpenSSL ì‹¤í–‰ ì‹¤íŒ¨. Stderr: {result.stderr}")
            raise FileNotFoundError("OpenSSL ëª…ë ¹ ì‹¤í–‰ í›„ì—ë„ íŒŒì¼ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
            
    except Exception as e:
        print(f"âŒ SSL ì¸ì¦ì„œ ìƒì„± ì‹¤íŒ¨. OpenSSLì´ ì„¤ì¹˜ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”. ì˜¤ë¥˜: {e}")
        sys.exit(1)

# -------------------------------------------------------------------------
# 3. ì»¤ìŠ¤í…€ HTTP ìš”ì²­ í•¸ë“¤ëŸ¬
# -------------------------------------------------------------------------
class LargeDataHandler(BaseHTTPRequestHandler):
    """
    POST ìš”ì²­ì„ ì²˜ë¦¬í•˜ê³ , ëŒ€ìš©ëŸ‰ form-urlencoded ë°ì´í„°ë¥¼ íŒŒì‹±í•˜ì—¬ ì €ì¥í•©ë‹ˆë‹¤.
    """
    def _set_headers(self, status_code=200, message='OK'):
        self.send_response(status_code, message)
        self.send_header('Content-type', 'text/plain')
        self.end_headers()

    def do_POST(self):
        # 1. ê²½ë¡œ í™•ì¸
        if self.path != '/upload':
            self._set_headers(404, 'Not Found')
            self.wfile.write(b"404 Not Found")
            return

        # 2. Content-Length í—¤ë”ë¡œ ë°ì´í„° í¬ê¸° í™•ì¸
        try:
            content_length = int(self.headers['Content-Length'])
        except (TypeError, ValueError):
            self._set_headers(400, 'Bad Request')
            self.wfile.write(b"Missing or Invalid Content-Length")
            return

        if content_length > 0:
            try:
                # 3. ëŒ€ìš©ëŸ‰ ë°ì´í„° ì½ê¸°
                post_data_raw = self.rfile.read(content_length)
                
                # 4. form-urlencoded ë°ì´í„° íŒŒì‹±
                post_data_str = post_data_raw.decode('utf-8')
                parsed_data = parse_qs(post_data_str)
                
                # parse_qsì˜ ê²°ê³¼ëŠ” ë¦¬ìŠ¤íŠ¸ í˜•íƒœì´ë¯€ë¡œ ì²« ë²ˆì§¸ ìš”ì†Œë¥¼ ì¶”ì¶œí•˜ê³  URL ì¸ì½”ë”© í•´ì œ
                filename = unquote_plus(parsed_data.get('filename', ['received_log_default.txt'])[0])
                content = unquote_plus(parsed_data.get('content', [''])[0])
                
                if not content:
                    self._set_headers(204, 'No Content')
                    print(f"[{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}] âš ï¸ ë°ì´í„°ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.")
                    return

                # 5. íŒŒì¼ ì €ì¥ ë””ë ‰í† ë¦¬ í™•ì¸ ë° ìƒì„±
                # ë³€ê²½ëœ ê²½ë¡œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
                if not os.path.exists(RECEIVE_DIR):
                    os.makedirs(RECEIVE_DIR)

                # 6. íŒŒì¼ ì €ì¥ (ì•ˆì „í•œ íŒŒì¼ëª… ì²˜ë¦¬)
                timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
                safe_filename = re.sub(r'[^\w\.\-]', '_', filename)
                save_path = os.path.join(RECEIVE_DIR, f"received_{timestamp}_{safe_filename}")
                
                with open(save_path, 'w', encoding='utf-8', errors='ignore') as f:
                    f.write(content)

                # 7. ê²°ê³¼ ì¶œë ¥ ë° ì‘ë‹µ
                file_size_bytes = os.path.getsize(save_path)
                file_size_mib = file_size_bytes / (1024 * 1024)
                
                self._set_headers(200, 'Success')
                self.wfile.write(b"Data Received Successfully")
                
                print("-" * 50)
                print(f"[{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}] âœ… ëŒ€ìš©ëŸ‰ íŒŒì¼ ìˆ˜ì‹  ì„±ê³µ")
                print(f"  > íŒŒì¼ëª…: {safe_filename}")
                print(f"  > ì €ì¥ ê²½ë¡œ: {save_path}")
                print(f"  > í¬ê¸°: {file_size_mib:.2f} MiB ({file_size_bytes:,} bytes)")
                print("-" * 50)

            except Exception as e:
                self._set_headers(500, 'Internal Error')
                self.wfile.write(b"Internal Server Error")
                print(f"[{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}] âŒ ìˆ˜ì‹  ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
                
        else:
            self._set_headers(400, 'Bad Request')
            self.wfile.write(b"No Data Received")

# -------------------------------------------------------------------------
# 4. ì„œë²„ ì‹¤í–‰
# -------------------------------------------------------------------------
def run_server():
    """HTTPS ì„œë²„ë¥¼ ì‹œì‘í•˜ê³  SSL Contextë¥¼ ì ìš©í•©ë‹ˆë‹¤."""
    cert_file, key_file = generate_ssl_certs()
    
    try:
        # HTTP ì„œë²„ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
        httpd = HTTPServer(SERVER_ADDRESS, LargeDataHandler)
        
        # SSL Context ìƒì„± ë° ì¸ì¦ì„œ ë¡œë“œ
        context = ssl.create_default_context(ssl.Purpose.CLIENT_AUTH)
        context.load_cert_chain(certfile=cert_file, keyfile=key_file)
        
        # Context ê°ì²´ì˜ wrap_socket ë©”ì„œë“œë¥¼ ì‚¬ìš©í•˜ì—¬ ì†Œì¼“ ë˜í•‘
        httpd.socket = context.wrap_socket(httpd.socket, server_side=True)
        
        host, port = SERVER_ADDRESS
        print(f"â˜… HTTPS ì„œë²„ ì‹œì‘ ì¤‘ (Host: {host}, Port: {port})...")
        print(f"â˜… íŒŒì¼ ì €ì¥ ê²½ë¡œ: {RECEIVE_DIR}") # ë³€ê²½ëœ ê²½ë¡œ ì¶œë ¥
        print("â˜… (ì°¸ê³ : 443 í¬íŠ¸ëŠ” ê¶Œí•œ ë¬¸ì œë¡œ ì¸í•´ sudoë¡œ ì‹¤í–‰í•´ì•¼ í•©ë‹ˆë‹¤.)")
        
        httpd.serve_forever()

    except PermissionError:
        print("\nâŒ ê¶Œí•œ ì˜¤ë¥˜: 443 í¬íŠ¸ëŠ” root ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. 'sudo python3 [íŒŒì¼ ì´ë¦„].py'ë¡œ ì‹¤í–‰í•˜ì„¸ìš”.")
    except Exception as e:
        print(f"\nâŒ ì„œë²„ ì‹¤í–‰ ì¤‘ ì¹˜ëª…ì ì¸ ì˜¤ë¥˜ ë°œìƒ: {e}")

if __name__ == '__main__':
    run_server()